{% extends "formulario/base.html" %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}FORMULARIO DE Personal Data{% endblock %}

{% block content %}
<div class="d-flex align-items-center mb-4">
  <h2 class="mb-0">FORMULARIO DE Personal Data</h2>
</div>

<form method="post" enctype="multipart/form-data" id="wizardForm" novalidate>
  {% csrf_token %}

  <!-- Nav tabs -->
  <ul class="nav nav-tabs" id="formTabs" role="tablist">
  <li class="nav-item" role="presentation">
    <button class="nav-link active" id="tab-personal-data" data-bs-toggle="tab" data-bs-target="#personal_data" type="button" role="tab" aria-controls="personal_data" aria-selected="true">Personal Data</button>
  </li>
  <li class="nav-item" role="presentation">
    <button class="nav-link" id="tab-family-data" data-bs-toggle="tab" data-bs-target="#Family_Data" type="button" role="tab" aria-controls="Family_Data" aria-selected="false">Family Data</button>
  </li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#informacion_academica" type="button" role="tab">Información Académica</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#BienesRentasAEP" type="button" role="tab">Bienes, Rentas y Actividad Económica Privada</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#SituacionJuridica" type="button" role="tab">Situación Jurídica</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#confirmar" type="button" role="tab">Confirmar</button></li>
  </ul>

  <!-- Tab content -->
<div class="tab-content p-3 border border-top-0">
  <div class="tab-pane fade show active" id="personal_data" role="tabpanel" aria-labelledby="tab-personal-data">{% crispy f_PersonalData %}</div>



  <div class="tab-pane fade" id="Family_Data" role="tabpanel" aria-labelledby="tab-family-data">{% crispy f_FamilyData %}</div> 

  <div class="tab-pane fade" id="informacion_academica" role="tabpanel">{% crispy f_informacion_academica %}</div>

  <div class="tab-pane fade" id="BienesRentasAEP" role="tabpanel">{% crispy f_BienesRentasAEP %}</div>
  <div class="tab-pane fade" id="SituacionJuridica" role="tabpanel">{% crispy f_SituacionJuridica %}</div>
  <div class="tab-pane fade" id="confirmar" role="tabpanel">{% crispy f_confirm %}</div>
</div>

  <button type="submit" class="btn btn-success mt-4">Enviar</button>
</form>

{% endblock %}



{% block scripts %}
<!-- Dirección PersonalData -->
<script>
(function () {
  const prefix = "PersonalData";
  const id = f => `id_${prefix}-${f}`;
  const v = f => document.getElementById(id(f))?.value || "";
  const ck = f => document.getElementById(id(f))?.checked || false;

  
  //Dirección de la persona a ingresar

  function actualizarDireccion() {
    const partes = [
      v('tipo_via'), v('numero_principal'), v('letra_principal'),
      ck('bis') ? 'BIS' : '',
      v('letra_bis'), v('cuadrante')
    ];

    if (v('numero_secundario')) {
      partes.push('#', v('numero_secundario'), v('letra_secundaria'), v('cuadrante_dos'));
    }

    partes.push(v('nro'));

    let dir = partes.filter(Boolean).join(' ');
    if (v('complemento')) dir += ', ' + v('complemento');

    const div = document.getElementById('direccion-preview');
    const hidden = document.getElementById(id('direccion_preview'));
    if (div) div.textContent = dir;
    if (hidden) hidden.value = dir;
  }

  document.addEventListener('DOMContentLoaded', () => {
    const campos = [
      'tipo_via', 'numero_principal', 'letra_principal',
      'bis', 'letra_bis', 'cuadrante',
      'numero_secundario', 'letra_secundaria', 'cuadrante_dos',
      'nro', 'complemento'
    ];
    campos.forEach(f => {
      const el = document.getElementById(id(f));
      if (el) {
        el.addEventListener(el.type === 'checkbox' ? 'change' : 'input', actualizarDireccion);
      }
    });
    actualizarDireccion();
  });
})();
</script>


<!-- Dirección CÓNYUGE -->
<script>
(function () {
  const prefix = "FamilyData";
  const id = f => `id_${prefix}-${f}`;
  const v = f => document.getElementById(id(f))?.value || "";
  const ck = f => document.getElementById(id(f))?.checked || false;

  function actualizarDireccionConyugue() {
    const partes = [
      v('tipo_via_conyugue'), v('numero_principal_conyugue'), v('letra_principal_conyugue'),
      ck('bis_conyugue') ? 'BIS' : '',
      v('letra_bis_conyugue'), v('cuadrante_conyugue')
    ];

    if (v('numero_secundario_conyugue')) {
      partes.push('#', v('numero_secundario_conyugue'),
                        v('letra_secundaria_conyugue'),
                        v('cuadrante_dos_conyugue'));
    }

    partes.push(v('nro_conyugue'));

    let dir = partes.filter(Boolean).join(' ');
    if (v('complemento_conyugue')) dir += ', ' + v('complemento_conyugue');

    const div = document.getElementById('direccion-preview_conyugue');
    const hidden = document.getElementById(id('direccion_preview_conyugue'));
    if (div) div.textContent = dir;
    if (hidden) hidden.value = dir;
  }

  document.addEventListener('DOMContentLoaded', () => {
    const campos = [
      'tipo_via_conyugue', 'numero_principal_conyugue', 'letra_principal_conyugue',
      'bis_conyugue', 'letra_bis_conyugue', 'cuadrante_conyugue',
      'numero_secundario_conyugue', 'letra_secundaria_conyugue',
      'cuadrante_dos_conyugue', 'nro_conyugue', 'complemento_conyugue'
    ];
    campos.forEach(f => {
      const el = document.getElementById(id(f));
      if (el) {
        el.addEventListener(el.type === 'checkbox' ? 'change' : 'input', actualizarDireccionConyugue);
      }
    });
    actualizarDireccionConyugue();
  });
})();
</script>

<!-- Dirección PADRE -->
<script>
(function () {
  const prefix = "FamilyData";
  const id = f => `id_${prefix}-${f}`;
  const v = f => document.getElementById(id(f))?.value || "";
  const ck = f => document.getElementById(id(f))?.checked || false;

  function actualizarDireccionPadre() {
    const partes = [
      v('tipo_via_padre'), v('numero_principal_padre'), v('letra_principal_padre'),
      ck('bis_padre') ? 'BIS' : '',
      v('letra_bis_padre'), v('cuadrante_padre')
    ];

    if (v('numero_secundario_padre')) {
      partes.push('#', v('numero_secundario_padre'),
                        v('letra_secundaria_padre'),
                        v('cuadrante_dos_padre'));
    }

    partes.push(v('nro_padre'));

    let dir = partes.filter(Boolean).join(' ');
    if (v('complemento_padre')) dir += ', ' + v('complemento_padre');

    const div = document.getElementById('direccion-preview_padre');
    const hidden = document.getElementById(id('direccion_preview_padre'));
    if (div) div.textContent = dir;
    if (hidden) hidden.value = dir;
  }

  document.addEventListener('DOMContentLoaded', () => {
    const campos = [
      'tipo_via_padre', 'numero_principal_padre', 'letra_principal_padre',
      'bis_padre', 'letra_bis_padre', 'cuadrante_padre',
      'numero_secundario_padre', 'letra_secundaria_padre',
      'cuadrante_dos_padre', 'nro_padre', 'complemento_padre'
    ];
    campos.forEach(f => {
      const el = document.getElementById(id(f));
      if (el) {
        el.addEventListener(el.type === 'checkbox' ? 'change' : 'input', actualizarDireccionPadre);
      }
    });
    actualizarDireccionPadre();
  });
})();
</script>

<!-- Dirección MADRE -->
<script>
(function () {
  const prefix = "FamilyData";
  const id = f => `id_${prefix}-${f}`;
  const v = f => document.getElementById(id(f))?.value || "";
  const ck = f => document.getElementById(id(f))?.checked || false;

  function actualizarDireccionMadre() {
    const partes = [
      v('tipo_via_madre'), v('numero_principal_madre'), v('letra_principal_madre'),
      ck('bis_madre') ? 'BIS' : '',
      v('letra_bis_madre'), v('cuadrante_madre')
    ];

    if (v('numero_secundario_madre')) {
      partes.push('#', v('numero_secundario_madre'),
                        v('letra_secundaria_madre'),
                        v('cuadrante_dos_madre'));
    }

    partes.push(v('nro_madre'));

    let dir = partes.filter(Boolean).join(' ');
    if (v('complemento_madre')) dir += ', ' + v('complemento_madre');

    const div = document.getElementById('direccion-preview_madre');
    const hidden = document.getElementById(id('direccion_preview_madre'));
    if (div) div.textContent = dir;
    if (hidden) hidden.value = dir;
  }

  document.addEventListener('DOMContentLoaded', () => {
    const campos = [
      'tipo_via_madre', 'numero_principal_madre', 'letra_principal_madre',
      'bis_madre', 'letra_bis_madre', 'cuadrante_madre',
      'numero_secundario_madre', 'letra_secundaria_madre',
      'cuadrante_dos_madre', 'nro_madre', 'complemento_madre'
    ];
    campos.forEach(f => {
      const el = document.getElementById(id(f));
      if (el) {
        el.addEventListener(el.type === 'checkbox' ? 'change' : 'input', actualizarDireccionMadre);
      }
    });
    actualizarDireccionMadre();
  });
})();
</script>

<!-- AGREGAR Child -->

<script>
document.addEventListener("DOMContentLoaded", function () {
  const formset = document.getElementById("formset-Child");
  const totalForms = document.querySelector("#id_Child-TOTAL_FORMS");
  const emptyFormTemplate = document.getElementById("empty-form-Child").innerHTML;
  const addButton = document.getElementById("add-Child");

  function updateTitles() {
    const forms = formset.querySelectorAll(".Child-form:not(.d-none)");
    forms.forEach((form, index) => {
      const title = form.querySelector(".card-title");
      if (title) title.textContent = `Child ${index + 1}`;
    });
  }

  addButton.addEventListener("click", function () {
    const index = parseInt(totalForms.value);
    const newForm = document.createElement("div");
    newForm.innerHTML = emptyFormTemplate
      .replace(/__prefix__/g, index)
      .replace(/__NUM__/g, index + 1);

    formset.appendChild(newForm.firstElementChild);
    totalForms.value = index + 1;
    updateTitles();
  });

  // Manejar "Eliminar"
  formset.addEventListener("click", function (e) {
    if (e.target.classList.contains("delete-Child")) {
      const card = e.target.closest(".Child-form");
      const deleteInput = card.querySelector("input[name$='-DELETE']");
      if (deleteInput) {
        deleteInput.value = "on";           // <- corregido
        card.classList.add("d-none");
        updateTitles();
      }
    }
  });

  updateTitles();
});
</script>

<!-- AGREGAR Sibling-->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const formset = document.getElementById("formset-Sibling");
  const totalForms = document.querySelector("#id_Sibling-TOTAL_FORMS");
  const emptyFormTemplate = document.getElementById("empty-form-Sibling").innerHTML;
  const addButton = document.getElementById("add-Sibling");

  function updateTitles() {
    const forms = formset.querySelectorAll(".Sibling-form:not(.d-none)");
    forms.forEach((form, index) => {
      const title = form.querySelector(".card-title");
      if (title) title.textContent = `Sibling ${index + 1}`;
    });
  }

  addButton.addEventListener("click", function () {
    const index = parseInt(totalForms.value);
    const newForm = document.createElement("div");
    newForm.innerHTML = emptyFormTemplate
      .replace(/__prefix__/g, index)
      .replace(/__NUM__/g, index + 1);

    formset.appendChild(newForm.firstElementChild);
    totalForms.value = index + 1;
    updateTitles();
    const newCard = formset.lastElementChild;
    bindDireccionSiblingEvents(newCard);
  });

  formset.addEventListener("click", function (e) {
    if (e.target.classList.contains("delete-Sibling")) {
      const card = e.target.closest(".Sibling-form");
      const deleteInput = card.querySelector("input[name$='-DELETE']");
      if (deleteInput) {
        deleteInput.value = "on";
        card.classList.add("d-none");
        updateTitles();
      }
    }
  });

  updateTitles();
});
</script>

<!-- Dirección HSibling-->
<script>
function bindDireccionSiblingoEvents(card) {
  if (card.dataset.binded === "true") return;
  card.dataset.binded = "true";

  const campos = [
    'tipo_via_Sibling', 'numero_principal_Siblingo', 'letra_principal_Sibling',
    'bis_Sibling', 'letra_bis_Sibling', 'cuadrante_Sibling',
    'numero_secundario_Sibling', 'letra_secundaria_Sibling',
    'cuadrante_dos_Sibling', 'nro_Sibling', 'complemento_Sibling'
  ];

  function getVal(name) {
    return card.querySelector(`[name*='-${name}']`)?.value || '';
  }

  function isChecked(name) {
    return card.querySelector(`[name*='-${name}']`)?.checked || false;
  }

  function construirDireccion() {
    const partes = [
      getVal('tipo_via_Sibling'),
      getVal('numero_principal_Sibling'),
      getVal('letra_principal_Sibling'),
      isChecked('bis_Sibling') ? 'BIS' : '',
      getVal('letra_bis_Sibling'),
      getVal('cuadrante_Sibling')
    ];

    if (getVal('numero_secundario_Sibling')) {
      partes.push('#',
        getVal('numero_secundario_Sibling'),
        getVal('letra_secundaria_Sibling'),
        getVal('cuadrante_dos_Sibling')
      );
    }

    partes.push(getVal('nro_Sibling'));

    let dir = partes.filter(Boolean).join(' ');
    if (getVal('complemento_Sibling')) {
      dir += ', ' + getVal('complemento_Sibling');
    }

    const output = card.querySelector('.direccion-preview_Sibling');
    const hidden = [...card.querySelectorAll("input[type='hidden']")].find(
      input => input.name.includes("-direccion_formateada_Sibling")
    );

    if (output) output.textContent = dir;
    if (hidden) hidden.value = dir;
  }

  campos.forEach(name => {
    const input = card.querySelector(`[name*='-${name}']`);
    if (input) {
      input.addEventListener(input.type === 'checkbox' ? 'change' : 'input', construirDireccion);
    }
  });

  construirDireccion();
}

document.addEventListener("DOMContentLoaded", function () {
  document.querySelectorAll('.Sibling-form').forEach(bindDireccionSiblingEvents);

  const observer = new MutationObserver(() => {
    document.querySelectorAll('.Sibling-form').forEach(bindDireccionSiblingEvents);
  });

  observer.observe(document.getElementById('formset-Sibling'), {
    childList: true,
    subtree: true
  });
});
</script>



<!--Formateo de Moneda en los campos-->
<script>
document.addEventListener('DOMContentLoaded', function () {
    const inputIds = [
        'id_BienesRentasAEP-salarios_y_demas_ingresos_laborales',
        'id_BienesRentasAEP-cesantías_e_intereses_de_cesantías',
        'id_BienesRentasAEP-gastos_de_representación',
        'id_BienesRentasAEP-arriendos',
        'id_BienesRentasAEP-honorarios',
        'id_BienesRentasAEP-otros_ingresos_y_rentas'
    ];

    function formatMoneyInput(input) {
        const cursorPos = input.selectionStart;
        const rawValue = input.value.replace(/\./g, '').replace(/\D/g, '');
        const formatted = parseInt(rawValue || '0').toLocaleString('es-CO');
        const oldLength = input.value.length;
        input.value = formatted;
        const newLength = input.value.length;
        input.setSelectionRange(cursorPos + (newLength - oldLength), cursorPos + (newLength - oldLength));
    }

    function parseIntClean(id) {
        const el = document.getElementById(id);
        if (!el) return 0;
        return parseInt(el.value.replace(/\./g, '').replace(/\D/g, '')) || 0;
    }

    function updateTotal() {
        let total = 0;
        inputIds.forEach(id => total += parseIntClean(id));
        const totalField = document.getElementById('id_BienesRentasAEP-total_ingresos');
        if (totalField) totalField.value = '$' + total.toLocaleString('es-CO');
    }

    inputIds.forEach(id => {
        const input = document.getElementById(id);
        if (!input) return;

        input.setAttribute('inputmode', 'numeric'); // soporte móvil
        input.addEventListener('input', (e) => {
            formatMoneyInput(input);
            updateTotal();
        });

        // Formatear inicialmente
        formatMoneyInput(input);
    });

    updateTotal();
});
</script>

<!--Sumatoria de Ingresos-->
<script>
document.addEventListener('DOMContentLoaded', function () {
    function formatMoney(value) {
        return '$' + value.toLocaleString('es-CO');
    }

    function actualizarTotalIngresos() {
        const ids = [
            'id_BienesRentasAEP-salarios_y_demas_ingresos_laborales',
            'id_BienesRentasAEP-cesantías_e_intereses_de_cesantías',
            'id_BienesRentasAEP-gastos_de_representación',
            'id_BienesRentasAEP-arriendos',
            'id_BienesRentasAEP-honorarios',
            'id_BienesRentasAEP-otros_ingresos_y_rentas'
        ];
        let total = 0;

        ids.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                const val = parseInt(el.value.replace(/\D/g, '')) || 0;
                total += val;
            }
        });

        const totalInput = document.getElementById('id_BienesRentasAEP-total_ingresos');
        if (totalInput) totalInput.value = formatMoney(total);
    }

    const inputs = document.querySelectorAll('[id^="id_BienesRentasAEP-"]');
    inputs.forEach(input => input.addEventListener('input', actualizarTotalIngresos));
    actualizarTotalIngresos();  // Ejecutar al cargar
});
</script>

<!--Limpieza del dato-->
<script>
document.addEventListener('DOMContentLoaded', function () {
    const form = document.querySelector('form');
    if (!form) return;

    form.addEventListener('submit', function () {
        const ids = [
            'id_BienesRentasAEP-salarios_y_demas_ingresos_laborales',
            'id_BienesRentasAEP-cesantías_e_intereses_de_cesantías',
            'id_BienesRentasAEP-gastos_de_representación',
            'id_BienesRentasAEP-arriendos',
            'id_BienesRentasAEP-honorarios',
            'id_BienesRentasAEP-otros_ingresos_y_rentas'
        ];

        ids.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.value = el.value.replace(/\D/g, '');
            }
        });
    });
});
</script>

<!-- REDIRIGE AL ERROR -->

<script>
document.addEventListener("DOMContentLoaded", function () {
    // Encuentra el primer campo con error visible
    let errorInput = document.querySelector(".is-invalid");

    // Si no hay, intenta con errores generales (por ejemplo captcha o errores sin campos)
    if (!errorInput) {
        const errorMessages = document.querySelectorAll(".invalid-feedback, .errorlist");
        for (const error of errorMessages) {
            // Busca hacia arriba hasta encontrar la tab-pane donde está el error
            const parentTab = error.closest(".tab-pane");
            if (parentTab) {
                errorInput = parentTab.querySelector("input, textarea, select, div");
                break;
            }
        }
    }

    // Si se encuentra un input con error, enfoca la tab correspondiente
    if (errorInput) {
        const tabPane = errorInput.closest(".tab-pane");
        if (tabPane && tabPane.id) {
            const trigger = document.querySelector(`[data-bs-target="#${tabPane.id}"]`);
            if (trigger) {
                trigger.click();
            }
        }
    }
});
</script>

{% endblock %}