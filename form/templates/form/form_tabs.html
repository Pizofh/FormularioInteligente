{% extends "form/base.html" %}
{% load static %}
{% load crispy_forms_tags %}

{% block title %}PERSONAL DATA FORM{% endblock %}

{% block content %}
<div class="d-flex align-items-center mb-4">
  <h2 class="mb-0">PERSONAL DATA FORM</h2>
</div>

<form method="post" enctype="multipart/form-data" id="wizardForm" novalidate>
  {% csrf_token %}

  <!-- Navigation tabs -->
  <ul class="nav nav-tabs" id="formTabs" role="tablist">
    <li class="nav-item" role="presentation">
      <button class="nav-link active" id="tab-personal-data" data-bs-toggle="tab" data-bs-target="#personal_data" type="button" role="tab" aria-controls="personal_data" aria-selected="true">Personal Data</button>
    </li>
    <li class="nav-item" role="presentation">
      <button class="nav-link" id="tab-family-data" data-bs-toggle="tab" data-bs-target="#Family_Data" type="button" role="tab" aria-controls="Family_Data" aria-selected="false">Family Data</button>
    </li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#AcademicInformation" type="button" role="tab">Academic Information</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#AssetsIncomeAEP" type="button" role="tab">Assets and Income</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#LegalSituation" type="button" role="tab">Legal Situation</button></li>
    <li class="nav-item"><button class="nav-link" data-bs-toggle="tab" data-bs-target="#confirmar" type="button" role="tab">Confirm</button></li>
  </ul>

  <!-- Tab content -->
  <div class="tab-content p-3 border border-top-0">
    <div class="tab-pane fade show active" id="personal_data" role="tabpanel" aria-labelledby="tab-personal-data">{% crispy f_PersonalData %}</div>
    <div class="tab-pane fade" id="Family_Data" role="tabpanel" aria-labelledby="tab-family-data">{% crispy f_FamilyData %}</div>
    <div class="tab-pane fade" id="AcademicInformation" role="tabpanel">{% crispy f_AcademicInformation %}</div>
    <div class="tab-pane fade" id="AssetsIncomeAEP" role="tabpanel">{% crispy f_AssetsIncomeAEP %}</div>
    <div class="tab-pane fade" id="LegalSituation" role="tabpanel">{% crispy f_LegalSituation %}</div>
    <div class="tab-pane fade" id="confirmar" role="tabpanel">{% crispy f_confirm %}</div>
  </div>

  <button type="submit" class="btn btn-success mt-4">Submit</button>
</form>
{% endblock %}



{% block scripts %}
<!-- Personal Address -->
<script>
(function () {
  const prefix = "PersonalData";
  const id = f => `id_${prefix}-${f}`;
  const v = f => document.getElementById(id(f))?.value || "";
  const ck = f => document.getElementById(id(f))?.checked || false;

  function updateAddress() {
    const parts = [
      v('street_type'), v('principal_number'), v('principal_letter'),
      ck('bis') ? 'BIS' : '',
      v('bis_letter'), v('quadrant')
    ];

    if (v('secondary_number')) {
      parts.push('#', v('secondary_number'), v('secondary_letter'), v('quadrant_2'));
    }

    parts.push(v('nmbr'));

    let address = parts.filter(Boolean).join(' ');
    if (v('complement')) address += ', ' + v('complement');

    const div = document.getElementById('direccion-preview');
    const hidden = document.getElementById(id('direccion_preview'));
    if (div) div.textContent = address;
    if (hidden) hidden.value = address;
  }

  document.addEventListener('DOMContentLoaded', () => {
    const fields = [
      'street_type', 'principal_number', 'principal_letter',
      'bis', 'bis_letter', 'quadrant',
      'secondary_number', 'secondary_letter', 'quadrant_2',
      'nmbr', 'complement'
    ];
    fields.forEach(f => {
      const el = document.getElementById(id(f));
      if (el) {
        el.addEventListener(el.type === 'checkbox' ? 'change' : 'input', updateAddress);
      }
    });
    updateAddress();
  });
})();
</script>



<!-- Spouse Address -->
<script>
(function () {
  const prefix = "FamilyData";
  const id = f => `id_${prefix}-${f}`;
  const v = f => document.getElementById(id(f))?.value || "";
  const ck = f => document.getElementById(id(f))?.checked || false;

  function updateSpouseAddress() {
    const parts = [
      v('spouse_street_type'), v('spouse_principal_number'), v('spouse_principal_letter'),
      ck('spouse_bis') ? 'BIS' : '',
      v('spouse_bis_letter'), v('spouse_quadrant')
    ];

    if (v('spouse_second_number')) {
      parts.push('#', v('spouse_second_number'),
                      v('spouse_second_letter'),
                      v('spouse_second_quadrant'));
    }

    parts.push(v('spouse_nmbr'));

    let address = parts.filter(Boolean).join(' ');
    if (v('spouse_complement')) address += ', ' + v('spouse_complement');

    const div = document.getElementById('spouse_preview_address');
    const hidden = document.getElementById(id('spouse_preview_address'));
    if (div) div.textContent = address;
    if (hidden) hidden.value = address;
  }

  document.addEventListener('DOMContentLoaded', () => {
    const fields = [
      'spouse_street_type', 'spouse_principal_number', 'spouse_principal_letter',
      'spouse_bis', 'spouse_bis_letter', 'spouse_quadrant',
      'spouse_second_number', 'spouse_second_letter',
      'spouse_second_quadrant', 'spouse_nmbr', 'spouse_complement'
    ];
    fields.forEach(f => {
      const el = document.getElementById(id(f));
      if (el) {
        el.addEventListener(el.type === 'checkbox' ? 'change' : 'input', updateSpouseAddress);
      }
    });
    updateSpouseAddress();
  });
})();
</script>


<!-- Father's Address -->
<script>
(function () {
  const prefix = "FamilyData";
  const id = f => `id_${prefix}-${f}`;
  const v = f => document.getElementById(id(f))?.value || "";
  const ck = f => document.getElementById(id(f))?.checked || false;

  function updateFatherAddress() {
    const parts = [
      v('father_street_type'), v('father_principal_number'), v('father_principal_letter'),
      ck('father_bis') ? 'BIS' : '',
      v('father_bis_letter'), v('father_quadrant')
    ];

    if (v('father_second_number')) {
      parts.push('#', v('father_second_number'),
                      v('father_second_letter'),
                      v('father_second_quadrant'));
    }

    parts.push(v('father_nmbr'));

    let address = parts.filter(Boolean).join(' ');
    if (v('father_complement')) address += ', ' + v('father_complement');

    const div = document.getElementById('father_preview_address');
    const hidden = document.getElementById(id('father_preview_address'));
    if (div) div.textContent = address;
    if (hidden) hidden.value = address;
  }

  document.addEventListener('DOMContentLoaded', () => {
    const fields = [
      'father_street_type', 'father_principal_number', 'father_principal_letter',
      'father_bis', 'father_bis_letter', 'father_quadrant',
      'father_second_number', 'father_second_letter',
      'father_second_quadrant', 'father_nmbr', 'father_complement'
    ];
    fields.forEach(f => {
      const el = document.getElementById(id(f));
      if (el) {
        el.addEventListener(el.type === 'checkbox' ? 'change' : 'input', updateFatherAddress);
      }
    });
    updateFatherAddress();
  });
})();
</script>


<!-- Mother's Address -->
<script>
(function () {
  const prefix = "FamilyData";
  const id = f => `id_${prefix}-${f}`;
  const v = f => document.getElementById(id(f))?.value || "";
  const ck = f => document.getElementById(id(f))?.checked || false;

  function updateMotherAddress() {
    const parts = [
      v('mother_street_type'), v('mother_principal_number'), v('mother_principal_letter'),
      ck('mother_bis') ? 'BIS' : '',
      v('mother_bis_letter'), v('mother_quadrant')
    ];

    if (v('mother_second_number')) {
      parts.push('#', v('mother_second_number'),
                        v('mother_second_letter'),
                        v('mother_second_quadrant'));
    }

    parts.push(v('mother_nmbr'));

    let address = parts.filter(Boolean).join(' ');
    if (v('mother_complement')) address += ', ' + v('mother_complement');

    const div = document.getElementById('mother_preview_address');
    const hidden = document.getElementById(id('mother_preview_address'));
    if (div) div.textContent = address;
    if (hidden) hidden.value = address;
  }

  document.addEventListener('DOMContentLoaded', () => {
    const fields = [
      'mother_street_type', 'mother_principal_number', 'mother_principal_letter',
      'mother_bis', 'mother_bis_letter', 'mother_quadrant',
      'mother_second_number', 'mother_second_letter',
      'mother_second_quadrant', 'mother_nmbr', 'mother_complement'
    ];
    fields.forEach(f => {
      const el = document.getElementById(id(f));
      if (el) {
        el.addEventListener(el.type === 'checkbox' ? 'change' : 'input', updateMotherAddress);
      }
    });
    updateMotherAddress();
  });
})();
</script>


<!-- AGREGAR Child -->

<script>
document.addEventListener("DOMContentLoaded", function () {
  const formset = document.getElementById("formset-Child");
  const totalForms = document.querySelector("#id_Child-TOTAL_FORMS");
  const emptyFormTemplate = document.getElementById("empty-form-Child").innerHTML;
  const addButton = document.getElementById("add-Child");

  function updateTitles() {
    const forms = formset.querySelectorAll(".Child-form:not(.d-none)");
    forms.forEach((form, index) => {
      const title = form.querySelector(".card-title");
      if (title) title.textContent = `Child ${index + 1}`;
    });
  }

  addButton.addEventListener("click", function () {
    const index = parseInt(totalForms.value);
    const newForm = document.createElement("div");
    newForm.innerHTML = emptyFormTemplate
      .replace(/__prefix__/g, index)
      .replace(/__NUM__/g, index + 1);

    formset.appendChild(newForm.firstElementChild);
    totalForms.value = index + 1;
    updateTitles();
  });

  // Manejar "Eliminar"
  formset.addEventListener("click", function (e) {
    if (e.target.classList.contains("delete-Child")) {
      const card = e.target.closest(".Child-form");
      const deleteInput = card.querySelector("input[name$='-DELETE']");
      if (deleteInput) {
        deleteInput.value = "on";           // <- corregido
        card.classList.add("d-none");
        updateTitles();
      }
    }
  });

  updateTitles();
});
</script>

<!-- Add Sibling-->
<script>
document.addEventListener("DOMContentLoaded", function () {
  const formset = document.getElementById("formset-Sibling");
  const totalForms = document.querySelector("#id_Sibling-TOTAL_FORMS");
  const emptyFormTemplate = document.getElementById("empty-form-Sibling").innerHTML;
  const addButton = document.getElementById("add-Sibling");

  function updateTitles() {
    const forms = formset.querySelectorAll(".Sibling-form:not(.d-none)");
    forms.forEach((form, index) => {
      const title = form.querySelector(".card-title");
      if (title) title.textContent = `Sibling ${index + 1}`;
    });
  }

  addButton.addEventListener("click", function () {
    const index = parseInt(totalForms.value);
    const newForm = document.createElement("div");
    newForm.innerHTML = emptyFormTemplate
      .replace(/__prefix__/g, index)
      .replace(/__NUM__/g, index + 1);

    formset.appendChild(newForm.firstElementChild);
    totalForms.value = index + 1;
    updateTitles();
    const newCard = formset.lastElementChild;
    bindSiblingAddressEvents(newCard);
  });

  formset.addEventListener("click", function (e) {
    if (e.target.classList.contains("delete-Sibling")) {
      const card = e.target.closest(".Sibling-form");
      const deleteInput = card.querySelector("input[name$='-DELETE']");
      if (deleteInput) {
        deleteInput.value = "on";
        card.classList.add("d-none");
        updateTitles();
      }
    }
  });

  updateTitles();
});
</script>

<!-- Sibling Address -->
<script>
function bindSiblingAddressEvents(card) {
  if (card.dataset.binded === "true") return;
  card.dataset.binded = "true";

  /* ⬇️  Usa los nombres reales de los campos  ⬇️ */
  const fields = [
    'sibling_street_type', 'sibling_principal_number', 'sibling_principal_letter',
    'sibling_bis', 'sibling_bis_letter', 'sibling_quadrant',
    'sibling_second_number', 'sibling_second_letter',
    'sibling_second_quadrant', 'sibling_nmbr', 'sibling_complement'
  ];

  const getValue = name =>
    card.querySelector(`[name$='-${name}']`)?.value || '';

  const isChecked = name =>
    card.querySelector(`[name$='-${name}']`)?.checked || false;

  function buildAddress() {
    const parts = [
      getValue('sibling_street_type'),
      getValue('sibling_principal_number'),
      getValue('sibling_principal_letter'),
      isChecked('sibling_bis') ? 'BIS' : '',
      getValue('sibling_bis_letter'),
      getValue('sibling_quadrant')
    ];

    if (getValue('sibling_second_number')) {
      parts.push('#',
        getValue('sibling_second_number'),
        getValue('sibling_second_letter'),
        getValue('sibling_second_quadrant')
      );
    }

    parts.push(getValue('sibling_nmbr'));

    let address = parts.filter(Boolean).join(' ');
    if (getValue('sibling_complement')) {
      address += ', ' + getValue('sibling_complement');
    }

    const output = card.querySelector('.direccion-preview_Sibling');
    const hidden = card.querySelector("input[name$='-sibling_built_address']");

    if (output) output.textContent = address;
    if (hidden) hidden.value = address;
  }

  /* Escucha cambios */
  fields.forEach(name => {
    const input = card.querySelector(`[name$='-${name}']`);
    if (input) {
      input.addEventListener(
        input.type === 'checkbox' ? 'change' : 'input',
        buildAddress
      );
    }
  });

  buildAddress();
}

document.addEventListener('DOMContentLoaded', () => {
  document
    .querySelectorAll('.Sibling-form')
    .forEach(bindSiblingAddressEvents);

  /* Nuevo hermano → vuelve a enlazar */
  const observer = new MutationObserver(() => {
    document
      .querySelectorAll('.Sibling-form')
      .forEach(bindSiblingAddressEvents);
  });

  observer.observe(document.getElementById('formset-Sibling'), {
    childList: true,
    subtree: true
  });
});
</script>



<!-- Currency Formatting in Fields -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    const inputIds = [
        'id_AssetsIncomeAEP-salary_and_other_income',
        'id_AssetsIncomeAEP-layoff_and_interests',
        'id_AssetsIncomeAEP-representation_expenses',
        'id_AssetsIncomeAEP-leases',
        'id_AssetsIncomeAEP-fee',
        'id_AssetsIncomeAEP-other_income'
    ];

    function formatMoneyInput(input) {
        const cursorPos = input.selectionStart;
        const rawValue = input.value.replace(/\./g, '').replace(/\D/g, '');
        const formatted = parseInt(rawValue || '0').toLocaleString('en-US');
        const oldLength = input.value.length;
        input.value = formatted;
        const newLength = input.value.length;
        input.setSelectionRange(cursorPos + (newLength - oldLength), cursorPos + (newLength - oldLength));
    }

    function parseIntClean(id) {
        const el = document.getElementById(id);
        if (!el) return 0;
        return parseInt(el.value.replace(/\./g, '').replace(/\D/g, '')) || 0;
    }

    function updateTotal() {
        let total = 0;
        inputIds.forEach(id => total += parseIntClean(id));
        const totalField = document.getElementById('id_AssetsIncomeAEP-total_income');
        if (totalField) totalField.value = '$' + total.toLocaleString('en-US');
    }

    inputIds.forEach(id => {
        const input = document.getElementById(id);
        if (!input) return;

        input.setAttribute('inputmode', 'numeric'); // mobile support
        input.addEventListener('input', (e) => {
            formatMoneyInput(input);
            updateTotal();
        });

        // Initial formatting
        formatMoneyInput(input);
    });

    updateTotal();
});
</script>


<!--Income Sum Calculation-->
<script>
document.addEventListener('DOMContentLoaded', function () {
    function formatMoney(value) {
        return '$' + value.toLocaleString('es-CO');
    }

    function updateTotalIncome() {
        const ids = [
            'id_AssetsIncomeAEP-salary_and_other_income',
            'id_AssetsIncomeAEP-layoff_and_interests',
            'id_AssetsIncomeAEP-representation_expenses',
            'id_AssetsIncomeAEP-leases',
            'id_AssetsIncomeAEP-fee',
            'id_AssetsIncomeAEP-other_income'
        ];
        let total = 0;

        ids.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                const val = parseInt(el.value.replace(/\D/g, '')) || 0;
                total += val;
            }
        });

        const totalInput = document.getElementById('id_AssetsIncomeAEPForm-total_income');
        if (totalInput) totalInput.value = formatMoney(total);
    }

    const inputs = document.querySelectorAll('[id^="id_AssetsIncomeAEP-"]');
    inputs.forEach(input => input.addEventListener('input', updateTotalIncome));
    updateTotalIncome();  // Run on load
});
</script>



<!-- Data sanitization -->
<script>
document.addEventListener('DOMContentLoaded', function () {
    const form = document.querySelector('form');
    if (!form) return;

    form.addEventListener('submit', function () {
        const ids = [
            'id_AssetsIncomeAEP-salary_and_other_income',
            'id_AssetsIncomeAEP-layoff_and_interests',
            'id_AssetsIncomeAEP-representation_expenses',
            'id_AssetsIncomeAEP-leases',
            'id_AssetsIncomeAEP-fee',
            'id_AssetsIncomeAEP-other_income'
        ];

        ids.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.value = el.value.replace(/\D/g, ''); // Remove all non-digit characters
            }
        });
    });
});
</script>


<!-- REDIRECT TO ERROR -->

<script>
document.addEventListener("DOMContentLoaded", function () {
    // Find the first visible field with an error
    let errorInput = document.querySelector(".is-invalid");

    // If none is found, look for general errors (e.g., captcha or non-field errors)
    if (!errorInput) {
        const errorMessages = document.querySelectorAll(".invalid-feedback, .errorlist");
        for (const error of errorMessages) {
            // Traverse up to find the tab-pane where the error is located
            const parentTab = error.closest(".tab-pane");
            if (parentTab) {
                errorInput = parentTab.querySelector("input, textarea, select, div");
                break;
            }
        }
    }

    // If an input with error is found, focus the corresponding tab
    if (errorInput) {
        const tabPane = errorInput.closest(".tab-pane");
        if (tabPane && tabPane.id) {
            const trigger = document.querySelector(`[data-bs-target="#${tabPane.id}"]`);
            if (trigger) {
                trigger.click();
            }
        }
    }
});
</script>


{% endblock %}